apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    tier: ops
  name: ops-dcgm-exporter
  namespace: monitoring
spec:
  endpoints:
  - interval: 15s
    port: metrics
    relabelings:
    - action: replace
      sourceLabels:
      - __meta_kubernetes_endpoint_node_name
      targetLabel: node
    metricRelabelings:
    # 只保留核心的 GPU 指标
    - action: keep
      regex: DCGM_(FI_DEV_GPU_UTIL|FI_DEV_MEM_COPY_UTIL|FI_DEV_FB_USED|FI_DEV_FB_FREE|FI_DEV_GPU_TEMP|FI_DEV_POWER_USAGE|FI_DEV_SM_CLOCK|FI_DEV_MEM_CLOCK|FI_DEV_PCIE_REPLAY_COUNTER|FI_DEV_XID_ERRORS)
      sourceLabels:
      - __name__
  namespaceSelector:
    matchNames:
    - monitoring
  selector:
    matchLabels:
      app.kubernetes.io/name: dcgm-exporter
  targetLabels:
  - app